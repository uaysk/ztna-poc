
location /test/ {
    # Be extra explicit to force Nginx to evaluate the variable.
    set $my_uri $request_uri;
    set $auth_uri "/api/check_auth?uri=$my_uri";
    auth_request $auth_uri;

    # If auth fails (401 or 403), show a custom error.
    error_page 401 403 = @error_response;

    proxy_pass http://localhost:8000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}
